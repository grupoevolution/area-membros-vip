<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Webhook</title>
    <style>
        body {
            background: #1a1a1a;
            color: white;
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        button {
            background: #E50914;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
        }
        button:hover {
            background: #cc0000;
        }
        .logs {
            background: #000;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            font-family: monospace;
            font-size: 12px;
            line-height: 1.4;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        input, textarea {
            width: 100%;
            padding: 10px;
            background: #333;
            border: 1px solid #555;
            color: white;
            border-radius: 4px;
            margin: 5px 0;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .info { color: #2196F3; }
        .warning { color: #ff9800; }
    </style>
</head>
<body>
    <h1>üîß Teste de Webhook - Membros VIP</h1>

    <!-- Se√ß√£o 1: Debug do Banco -->
    <div class="container">
        <h2>üìä Debug do Banco de Dados</h2>
        <button onclick="debugProducts()">Ver Produtos</button>
        <button onclick="debugAccess()">Ver Todos os Acessos</button>
        <button onclick="debugAccessCauan()">Ver Acesso do Cauan</button>
        <div id="dbResults" class="logs"></div>
    </div>

    <!-- Se√ß√£o 2: Simular Webhook -->
    <div class="container">
        <h2>üé≠ Simular Webhook PerfectPay</h2>
        <p>Simule um pagamento aprovado para testar o webhook:</p>
        
        <input type="email" id="webhookEmail" value="cauapetry2006@gmail.com" placeholder="Email do cliente">
        <input type="text" id="webhookPlan" value="PPLQQLST6" placeholder="C√≥digo do plano">
        
        <button onclick="simulateWebhook()">üöÄ Simular Webhook</button>
        <button onclick="simpleAccess()">‚ö° Acesso Direto (Simples)</button>
        
        <div id="webhookResults" class="logs"></div>
    </div>

    <!-- Se√ß√£o 3: Testar Acesso -->
    <div class="container">
        <h2>üîì Testar Verifica√ß√£o de Acesso</h2>
        <p>Teste se o usu√°rio tem acesso ao produto:</p>
        
        <input type="email" id="testEmail" value="cauapetry2006@gmail.com" placeholder="Email para testar">
        <input type="text" id="testPlan" value="PPLQQLST6" placeholder="C√≥digo do plano">
        
        <button onclick="testAccess()">üîç Verificar Acesso</button>
        
        <div id="accessResults" class="logs"></div>
    </div>

    <!-- Se√ß√£o 4: Webhook Real -->
    <div class="container">
        <h2>üì° Webhook PerfectPay Real</h2>
        <p>Cole aqui o payload real que voc√™ recebeu do PerfectPay:</p>
        
        <textarea id="realWebhook" rows="10" placeholder='{"sale_status_enum_key": "approved", "customer": {"email": "cauapetry2006@gmail.com"}, "plan": {"code": "PPLQQLST6", "name": "Plano VIP"}, ...}'></textarea>
        
        <button onclick="sendRealWebhook()">üì§ Enviar Webhook Real</button>
        
        <div id="realResults" class="logs"></div>
    </div>

    <script>
        const API_BASE = '';
        
        function log(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            container.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            container.scrollTop = container.scrollHeight;
        }
        
        function clearLog(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        // Debug Functions
        async function debugProducts() {
            clearLog('dbResults');
            log('dbResults', 'üì¶ Buscando produtos...', 'info');
            
            try {
                const response = await fetch('/debug/products');
                const data = await response.json();
                
                log('dbResults', `‚úÖ Produtos encontrados: ${data.products?.length || 0}`, 'success');
                
                data.products?.forEach((product, index) => {
                    log('dbResults', `\nüìã Produto ${index + 1}:`, 'info');
                    log('dbResults', `   ID: ${product.id}`, 'info');
                    log('dbResults', `   Nome: ${product.name}`, 'info');
                    log('dbResults', `   Plano 1: ${product.plano_1 || 'N√£o definido'}`, 'info');
                    log('dbResults', `   Plano 2: ${product.plano_2 || 'N√£o definido'}`, 'info');
                    log('dbResults', `   Plano 3: ${product.plano_3 || 'N√£o definido'}`, 'info');
                    log('dbResults', `   Categoria: ${product.category}`, 'info');
                });
                
            } catch (error) {
                log('dbResults', `‚ùå Erro: ${error.message}`, 'error');
            }
        }
        
        async function debugAccess() {
            clearLog('dbResults');
            log('dbResults', 'üîì Buscando todos os acessos...', 'info');
            
            try {
                const response = await fetch('/debug/access');
                const data = await response.json();
                
                log('dbResults', `‚úÖ Acessos encontrados: ${data.access_records?.length || 0}`, 'success');
                
                data.access_records?.forEach((access, index) => {
                    log('dbResults', `\nüé´ Acesso ${index + 1}:`, 'info');
                    log('dbResults', `   Email: ${access.email}`, 'info');
                    log('dbResults', `   Plano: ${access.plan_code} (${access.plan_name})`, 'info');
                    log('dbResults', `   Status: ${access.status}`, 'info');
                    log('dbResults', `   Criado: ${access.created_at}`, 'info');
                });
                
            } catch (error) {
                log('dbResults', `‚ùå Erro: ${error.message}`, 'error');
            }
        }
        
        async function debugAccessCauan() {
            clearLog('dbResults');
            log('dbResults', 'üîç Buscando acessos do Cauan...', 'info');
            
            try {
                const response = await fetch('/debug/access/cauapetry2006@gmail.com');
                const data = await response.json();
                
                log('dbResults', `‚úÖ Acessos do ${data.email}: ${data.total}`, 'success');
                
                if (data.total === 0) {
                    log('dbResults', '‚ùå Nenhum acesso encontrado para este email!', 'error');
                    log('dbResults', 'üí° Execute "Acesso Direto (Simples)" para criar um acesso de teste', 'warning');
                } else {
                    data.access_records?.forEach((access, index) => {
                        log('dbResults', `\nüé´ Acesso ${index + 1}:`, 'info');
                        log('dbResults', `   Plano: ${access.plan_code} (${access.plan_name})`, 'info');
                        log('dbResults', `   Produto: ${access.product_name || 'N/A'}`, 'info');
                        log('dbResults', `   Status: ${access.status}`, 'info');
                        log('dbResults', `   Criado: ${access.created_at}`, 'info');
                    });
                }
                
            } catch (error) {
                log('dbResults', `‚ùå Erro: ${error.message}`, 'error');
            }
        }

        // Webhook Functions
        async function simpleAccess() {
            clearLog('webhookResults');
            const email = document.getElementById('webhookEmail').value;
            const plan = document.getElementById('webhookPlan').value;
            
            log('webhookResults', '‚ö° Criando acesso direto...', 'info');
            
            try {
                const response = await fetch('/debug/simulate-access', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        plan_code: plan
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log('webhookResults', `‚úÖ Acesso criado com sucesso!`, 'success');
                    log('webhookResults', `   ID: ${data.access_id}`, 'success');
                    log('webhookResults', `   Email: ${email}`, 'success');
                    log('webhookResults', `   Plano: ${plan}`, 'success');
                } else {
                    log('webhookResults', `‚ùå Erro: ${data.error}`, 'error');
                }
                
            } catch (error) {
                log('webhookResults', `‚ùå Erro: ${error.message}`, 'error');
            }
        }
        
        async function simulateWebhook() {
            clearLog('webhookResults');
            const email = document.getElementById('webhookEmail').value;
            const plan = document.getElementById('webhookPlan').value;
            
            log('webhookResults', 'üé≠ Simulando webhook PerfectPay...', 'info');
            
            const webhookPayload = {
                "sale_status_enum_key": "approved",
                "customer": {
                    "email": email,
                    "name": "Cliente Teste"
                },
                "product": {
                    "code": "PRODUCT_001",
                    "name": "Produto Teste"
                },
                "plan": {
                    "code": plan,
                    "name": "Plano VIP Teste"
                },
                "code": "SALE_" + Date.now(),
                "sale_amount": 97.00
            };
            
            log('webhookResults', `üì§ Enviando: ${JSON.stringify(webhookPayload, null, 2)}`, 'info');
            
            try {
                const response = await fetch('/webhook/perfectpay', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(webhookPayload)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log('webhookResults', `‚úÖ Webhook processado com sucesso!`, 'success');
                    log('webhookResults', `   ${data.message}`, 'success');
                    log('webhookResults', `   Email: ${data.email}`, 'success');
                    log('webhookResults', `   Plano: ${data.plan_code} (${data.plan})`, 'success');
                } else {
                    log('webhookResults', `‚ùå Erro: ${data.error}`, 'error');
                }
                
            } catch (error) {
                log('webhookResults', `‚ùå Erro: ${error.message}`, 'error');
            }
        }
        
        async function sendRealWebhook() {
            clearLog('realResults');
            const payload = document.getElementById('realWebhook').value;
            
            if (!payload.trim()) {
                log('realResults', '‚ùå Por favor, cole o payload do webhook!', 'error');
                return;
            }
            
            log('realResults', 'üì° Enviando webhook real...', 'info');
            
            try {
                const parsedPayload = JSON.parse(payload);
                log('realResults', `üì§ Payload: ${JSON.stringify(parsedPayload, null, 2)}`, 'info');
                
                const response = await fetch('/webhook/perfectpay', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: payload
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log('realResults', `‚úÖ Webhook processado!`, 'success');
                    log('realResults', `   ${data.message}`, 'success');
                } else {
                    log('realResults', `‚ùå Erro: ${data.error}`, 'error');
                }
                
            } catch (error) {
                if (error instanceof SyntaxError) {
                    log('realResults', `‚ùå JSON inv√°lido: ${error.message}`, 'error');
                } else {
                    log('realResults', `‚ùå Erro: ${error.message}`, 'error');
                }
            }
        }

        // Access Test Functions
        async function testAccess() {
            clearLog('accessResults');
            const email = document.getElementById('testEmail').value;
            const plan = document.getElementById('testPlan').value;
            
            log('accessResults', 'üîç Verificando acesso...', 'info');
            log('accessResults', `   Email: ${email}`, 'info');
            log('accessResults', `   Plano: ${plan}`, 'info');
            
            try {
                const response = await fetch('/api/check-access', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        plano_code: plan
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (data.hasAccess) {
                        log('accessResults', `‚úÖ ACESSO LIBERADO!`, 'success');
                        log('accessResults', `   ${data.message}`, 'success');
                        if (data.access) {
                            log('accessResults', `   Produto: ${data.access.product_name || 'N/A'}`, 'success');
                            log('accessResults', `   Criado: ${data.access.created_at}`, 'success');
                        }
                    } else {
                        log('accessResults', `‚ùå ACESSO NEGADO`, 'error');
                        log('accessResults', `   ${data.message}`, 'error');
                    }
                } else {
                    log('accessResults', `‚ùå Erro: ${data.error}`, 'error');
                }
                
            } catch (error) {
                log('accessResults', `‚ùå Erro: ${error.message}`, 'error');
            }
        }

        // Auto-load na p√°gina
        window.onload = function() {
            log('dbResults', 'üöÄ P√°gina carregada. Clique nos bot√µes para testar!', 'info');
            log('webhookResults', 'üé≠ Pronto para simular webhooks!', 'info');
            log('accessResults', 'üîç Pronto para testar acessos!', 'info');
            log('realResults', 'üì° Cole aqui o payload real do PerfectPay!', 'info');
        };
    </script>
</body>
</html>
